import{_ as R,u as D,r as y,a as M,i as $,E as i,f as B,c as V,b as t,w as o,e as u,o as w,g as S,h as b,y as z,d as h,n as C,q as A,v as L,R as O}from"./index-BDXlMFXp.js";import{g as P}from"./file-DAHnz2Kx.js";const T={class:"profile-container"},j={class:"header"},F=["src"],H="http://sxh8oib6z.hb-bkt.clouddn.com",Q={__name:"Profile",setup(W){const N=B(),d=D(),f=y(null),_=y(!1),x=y({uploadUrl:"http://upload-z1.qiniup.com"}),a=M({username:"",role:1,email:"",realName:"",avatar:""}),k={email:[{required:!0,validator:async(s,e,r)=>{var l;if(!e){r(new Error("请输入邮箱"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){r(new Error("请输入正确的邮箱格式"));return}if(e!==((l=d.userInfo)==null?void 0:l.email))try{(await d.checkEmail(e)).data?r(new Error("邮箱已存在")):r()}catch{r()}else r()},trigger:"blur"}],realName:[{required:!0,message:"请输入真实姓名",trigger:"blur"}]},U=async()=>{var s,e;if(f.value)try{await f.value.validate(),_.value=!0,await d.updateUserInfo({email:a.email,realName:a.realName,avatar:a.avatar}),i.success("修改成功")}catch(r){(e=(s=r.response)==null?void 0:s.data)!=null&&e.message?i.error(r.response.data.message):i.error("修改失败")}finally{_.value=!1}},E=()=>{N.push("/")},I=async({file:s})=>{const e=s.type.startsWith("image/"),r=s.size/1024/1024<2;if(!e){i.error("上传头像图片只能是图片格式!");return}if(!r){i.error("上传头像图片大小不能超过 2MB!");return}try{const n=await P(),l=s.name.split(".").pop()||"png",p=`avatars/${d.userInfo.id}_${Date.now()}.${l}`,m=new FormData;m.append("token",n),m.append("key",p),m.append("file",s);const g=await O.post(x.value.uploadUrl,m),v=`${H}/${g.data.key}`;a.avatar=v,i.success("头像上传成功!"),await U()}catch(n){console.error("Upload failed:",n),i.error("上传失败，请重试")}};return $(async()=>{try{await d.getUserInfo(),Object.assign(a,d.userInfo)}catch{i.error("获取用户信息失败"),N.push("/login")}}),(s,e)=>{const r=u("el-button"),n=u("el-input"),l=u("el-form-item"),p=u("el-tag"),m=u("el-icon"),g=u("el-upload"),v=u("el-form"),q=u("el-card");return w(),V("div",T,[t(q,{class:"profile-card"},{header:o(()=>[h("div",j,[e[4]||(e[4]=h("h2",null,"个人信息",-1)),t(r,{type:"primary",onClick:E},{default:o(()=>e[3]||(e[3]=[b("返回主页")])),_:1,__:[3]})])]),default:o(()=>[t(v,{ref_key:"formRef",ref:f,model:a,rules:k,"label-width":"80px",onSubmit:S(U,["prevent"])},{default:o(()=>[t(l,{label:"用户名"},{default:o(()=>[t(n,{modelValue:a.username,"onUpdate:modelValue":e[0]||(e[0]=c=>a.username=c),disabled:""},null,8,["modelValue"])]),_:1}),t(l,{label:"角色"},{default:o(()=>[t(p,{type:a.role===1?"success":"warning"},{default:o(()=>[b(z(a.role===1?"学生":"教师"),1)]),_:1},8,["type"])]),_:1}),t(l,{label:"邮箱",prop:"email"},{default:o(()=>[t(n,{modelValue:a.email,"onUpdate:modelValue":e[1]||(e[1]=c=>a.email=c),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1}),t(l,{label:"真实姓名",prop:"realName"},{default:o(()=>[t(n,{modelValue:a.realName,"onUpdate:modelValue":e[2]||(e[2]=c=>a.realName=c),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),t(l,{label:"头像"},{default:o(()=>[t(g,{class:"avatar-uploader","show-file-list":!1,"http-request":I},{default:o(()=>[e[5]||(e[5]=h("br",null,null,-1)),a.avatar?(w(),V("img",{key:0,src:a.avatar,class:"avatar"},null,8,F)):(w(),C(m,{key:1,class:"avatar-uploader-icon"},{default:o(()=>[t(A(L))]),_:1}))]),_:1,__:[5]})]),_:1}),t(l,null,{default:o(()=>[t(r,{type:"primary","native-type":"submit",loading:_.value},{default:o(()=>e[6]||(e[6]=[b(" 保存修改 ")])),_:1,__:[6]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})])}}},X=R(Q,[["__scopeId","data-v-a642e18f"]]);export{X as default};
